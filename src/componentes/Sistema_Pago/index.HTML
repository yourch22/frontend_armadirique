<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Armadirique - Checkout Premium</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap');

        * {
            font-family: 'Poppins', sans-serif;
        }

        .light-premium-bg {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 25%, #cbd5e1 50%, #94a3b8 75%, #64748b 100%);
            background-size: 400% 400%;
            animation: lightGradientShift 20s ease infinite;
            min-height: 100vh;
        }

        @keyframes lightGradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .glass-light {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(25px);
            border: 1px solid rgba(59, 130, 246, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .glass-dark {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(59, 130, 246, 0.3);
            box-shadow: 0 8px 32px rgba(59, 130, 246, 0.1);
        }

        .card-premium {
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 25px;
            border: none;
            overflow: hidden;
            position: relative;
        }

        .card-premium::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent, rgba(59, 130, 246, 0.1), transparent);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .card-premium:hover::before {
            opacity: 1;
        }

        .card-premium:hover {
            transform: translateY(-10px) scale(1.02);
            box-shadow: 0 25px 50px rgba(59, 130, 246, 0.2);
        }

        .payment-option {
            transition: all 0.4s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            border-radius: 20px;
            border: 2px solid rgba(59, 130, 246, 0.3);
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(15px);
            color: #1e293b;
        }

        .payment-option::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.3), transparent);
            transition: left 0.8s;
        }

        .payment-option:hover::before {
            left: 100%;
        }

        .payment-option:hover {
            transform: scale(1.05) rotate(1deg);
            box-shadow: 0 15px 35px rgba(59, 130, 246, 0.3);
            border-color: #3b82f6;
        }

        .payment-option.active {
            transform: scale(1.08) rotate(-1deg);
            box-shadow: 0 20px 40px rgba(59, 130, 246, 0.4);
            border-color: #3b82f6;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
        }

        .payment-option.active.yape {
            background: linear-gradient(135deg, #722F8E, #9B4BB8);
            border-color: #722F8E;
        }

        .payment-option.active.plin {
            background: linear-gradient(135deg, #0066CC, #3399FF);
            border-color: #0066CC;
        }

        .payment-option.active.paypal {
            background: linear-gradient(135deg, #0070ba, #003087);
            border-color: #0070ba;
        }

        .floating-glow {
            animation: floatGlow 8s ease-in-out infinite;
        }

        @keyframes floatGlow {
            0%, 100% { 
                transform: translateY(0px) rotate(0deg);
                box-shadow: 0 5px 15px rgba(59, 130, 246, 0.3);
            }
            25% { 
                transform: translateY(-15px) rotate(2deg);
                box-shadow: 0 15px 25px rgba(59, 130, 246, 0.4);
            }
            50% { 
                transform: translateY(-10px) rotate(0deg);
                box-shadow: 0 20px 30px rgba(59, 130, 246, 0.5);
            }
            75% { 
                transform: translateY(-5px) rotate(-2deg);
                box-shadow: 0 15px 25px rgba(59, 130, 246, 0.4);
            }
        }

        .slide-in-left {
            animation: slideInLeft 1s ease-out;
        }

        @keyframes slideInLeft {
            from {
                opacity: 0;
                transform: translateX(-50px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateX(0) scale(1);
            }
        }

        .slide-in-right {
            animation: slideInRight 1s ease-out;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(50px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateX(0) scale(1);
            }
        }

        .fade-in-up {
            animation: fadeInUp 1.2s ease-out;
        }

        @keyframes fadeInUp {
            from { 
                opacity: 0;
                transform: translateY(30px) scale(0.95);
            }
            to { 
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .btn-premium {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            border: none;
            transition: all 0.4s ease;
            position: relative;
            overflow: hidden;
            border-radius: 18px;
            font-weight: 700;
            box-shadow: 0 10px 30px rgba(59, 130, 246, 0.4);
            color: white;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-premium::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.7s;
        }

        .btn-premium:hover::before {
            left: 100%;
        }

        .btn-premium:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 20px 40px rgba(59, 130, 246, 0.6);
            background: linear-gradient(135deg, #1d4ed8 0%, #3b82f6 100%);
        }

        .btn-success-premium {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            box-shadow: 0 10px 30px rgba(16, 185, 129, 0.4);
        }

        .btn-success-premium:hover {
            box-shadow: 0 20px 40px rgba(16, 185, 129, 0.6);
        }

        .btn-danger-premium {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            box-shadow: 0 10px 30px rgba(239, 68, 68, 0.4);
        }

        .btn-danger-premium:hover {
            box-shadow: 0 20px 40px rgba(239, 68, 68, 0.6);
        }

        .input-premium {
            transition: all 0.4s ease;
            border-radius: 15px;
            border: 2px solid rgba(59, 130, 246, 0.3);
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            color: #1e293b;
            padding: 15px 20px;
        }

        .input-premium.error {
            border-color: #ef4444;
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.3);
        }

        .input-premium::placeholder {
            color: rgba(30, 41, 59, 0.6);
        }

        .input-premium:focus {
            transform: scale(1.02);
            box-shadow: 0 0 25px rgba(59, 130, 246, 0.4);
            border-color: #3b82f6;
            outline: none;
            background: rgba(255, 255, 255, 0.95);
        }

        .pulse-blue {
            animation: pulseBlue 4s infinite;
        }

        @keyframes pulseBlue {
            0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.8); }
            70% { box-shadow: 0 0 0 20px rgba(59, 130, 246, 0); }
            100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }

        .gradient-text-blue {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .qr-frame {
            width: 220px;
            height: 220px;
            border: 3px solid #3b82f6;
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
            position: relative;
            overflow: hidden;
            box-shadow: 0 15px 35px rgba(59, 130, 246, 0.3);
            transition: all 0.4s ease;
        }

        .qr-frame:hover {
            transform: scale(1.05) rotate(2deg);
            box-shadow: 0 20px 45px rgba(59, 130, 246, 0.4);
        }

        .qr-frame.yape {
            border-color: #722F8E;
            box-shadow: 0 15px 35px rgba(114, 47, 142, 0.3);
        }

        .qr-frame.plin {
            border-color: #0066CC;
            box-shadow: 0 15px 35px rgba(0, 102, 204, 0.3);
        }

        .qr-frame img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 20px;
        }

        .loading-premium {
            border: 4px solid rgba(59, 130, 246, 0.3);
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            animation: spinPremium 1.2s linear infinite;
        }

        @keyframes spinPremium {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .success-notification {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 35px;
            border-radius: 25px;
            text-align: center;
            margin-top: 30px;
            animation: slideInRight 0.8s ease-out;
            box-shadow: 0 20px 45px rgba(16, 185, 129, 0.3);
            border: 2px solid rgba(16, 185, 129, 0.5);
        }

        .error-notification {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            padding: 35px;
            border-radius: 25px;
            text-align: center;
            margin-top: 30px;
            animation: slideInRight 0.8s ease-out;
            box-shadow: 0 20px 45px rgba(239, 68, 68, 0.3);
            border: 2px solid rgba(239, 68, 68, 0.5);
        }

        .product-item {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 15px;
            border: 1px solid rgba(59, 130, 246, 0.2);
            transition: all 0.4s ease;
            color: #1e293b;
        }

        .product-item:hover {
            transform: translateX(10px) scale(1.02);
            box-shadow: 0 15px 30px rgba(59, 130, 246, 0.2);
            border-color: #3b82f6;
        }

        .invoice-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: fadeInUp 0.4s ease-out;
        }

        .invoice-panel {
            background: linear-gradient(135deg, #f8fafc, #e2e8f0);
            border-radius: 25px;
            padding: 40px;
            max-width: 700px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            animation: slideInLeft 0.5s ease-out;
            border: 2px solid rgba(59, 130, 246, 0.3);
            color: #1e293b;
        }

        .map-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: fadeInUp 0.4s ease-out;
        }

        .map-panel {
            background: linear-gradient(135deg, #f8fafc, #e2e8f0);
            border-radius: 25px;
            padding: 30px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideInLeft 0.5s ease-out;
            border: 2px solid rgba(59, 130, 246, 0.3);
            color: #1e293b;
        }

        .map-container {
            background: rgba(59, 130, 246, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid rgba(59, 130, 246, 0.3);
            min-height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #1e293b;
        }

        .location-result {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 15px;
            padding: 15px;
            margin: 10px 0;
            border: 1px solid rgba(59, 130, 246, 0.3);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .location-result:hover {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
            transform: translateX(5px);
        }

        .location-result.selected {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.2);
        }

        .section-divider {
            height: 2px;
            background: linear-gradient(90deg, transparent, #3b82f6, transparent);
            margin: 30px 0;
            border-radius: 1px;
        }

        .icon-glow {
            filter: drop-shadow(0 0 10px rgba(59, 130, 246, 0.6));
            animation: iconGlow 3s ease-in-out infinite alternate;
        }

        @keyframes iconGlow {
            from { filter: drop-shadow(0 0 10px rgba(59, 130, 246, 0.6)); }
            to { filter: drop-shadow(0 0 20px rgba(59, 130, 246, 0.9)); }
        }

        .error-text {
            color: #ef4444;
            font-size: 0.875rem;
            margin-top: 5px;
        }

        .address-mode-toggle {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 15px;
            padding: 5px;
            margin-bottom: 20px;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .address-mode-btn {
            background: transparent;
            border: none;
            color: #1e293b;
            padding: 10px 20px;
            border-radius: 10px;
            transition: all 0.3s ease;
            flex: 1;
        }

        .address-mode-btn.active {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
        }

        .text-blue {
            color: #3b82f6;
        }

        .text-primary-custom {
            color: #1d4ed8;
        }

        .bg-light-premium {
            background: rgba(255, 255, 255, 0.9);
        }

        .border-blue {
            border-color: #3b82f6 !important;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding-left: 10px;
                padding-right: 10px;
            }
            
            .card-premium {
                margin-bottom: 20px;
            }
            
            .payment-option {
                margin-bottom: 15px;
            }
            
            .btn-premium {
                padding: 15px 25px;
                font-size: 16px;
            }
            
            .floating-glow {
                animation: none;
            }
            
            .qr-frame {
                width: 180px;
                height: 180px;
            }
        }

        @media (max-width: 576px) {
            .qr-frame {
                width: 160px;
                height: 160px;
            }
            
            .invoice-panel, .map-panel {
                padding: 25px;
                margin: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="light-premium-bg">
        <!-- Header premium con iconos de mueblería -->
        <nav class="navbar navbar-expand-lg glass-dark sticky-top">
            <div class="container">
                <a class="navbar-brand fw-bold fs-2 text-dark floating-glow" href="#">
                    <i class="fas fa-couch me-3 icon-glow"></i>
                    <span class="d-none d-sm-inline gradient-text-blue">Armadirique</span>
                    <span class="d-inline d-sm-none gradient-text-blue">ARM</span>
                </a>
                <div class="d-flex align-items-center">
                    <span class="badge bg-primary text-white me-3 pulse-blue px-4 py-2 fw-bold">
                        <i class="fas fa-shield-check me-2"></i>
                        <span class="d-none d-sm-inline">PAGO SEGURO</span>
                        <span class="d-inline d-sm-none">SEGURO</span>
                    </span>
                </div>
            </div>
        </nav>

        <div class="container py-4">
            <!-- Título principal -->
            <div class="text-center mb-5">
                <h1 class="display-3 fw-bold text-dark mb-4 floating-glow">
                    <i class="fas fa-home me-3 text-blue icon-glow"></i>
                    <span class="gradient-text-blue">CHECKOUT MUEBLERÍA</span>
                </h1>
                <p class="lead text-dark opacity-75 fs-4">Experiencia de compra premium para su hogar</p>
                <div class="section-divider"></div>
            </div>

            <div class="row g-4">
                <!-- Columna izquierda - Resumen del pedido -->
                <div class="col-xl-4 col-lg-5">
                    <div class="card card-premium glass-dark slide-in-left">
                        <div class="card-header text-center py-4 border-0" style="background: linear-gradient(135deg, #3b82f6, #1d4ed8)">
                            <h4 class="mb-0 fw-bold text-white">
                                <i class="fas fa-chair me-3"></i>
                                RESUMEN DE COMPRA
                            </h4>
                        </div>
                        <div class="card-body p-4">
                            <!-- Lista de productos -->
                            <div class="mb-4">
                                <h6 class="fw-bold mb-4 gradient-text-blue fs-5">MUEBLES SELECCIONADOS</h6>
                                <div id="products-list">
                                    <!-- Los productos se cargarán dinámicamente -->
                                </div>
                            </div>

                            <div class="section-divider"></div>

                            <!-- Totales -->
                            <div class="pt-3">
                                <div class="d-flex justify-content-between mb-3 text-dark">
                                    <span class="fs-6">Subtotal:</span>
                                    <span class="fw-semibold" id="subtotal">S/ 0.00</span>
                                </div>
                                <div class="d-flex justify-content-between mb-3 text-dark">
                                    <span class="fs-6">Envío:</span>
                                    <span class="fw-semibold" id="shipping">S/ 0.00</span>
                                </div>
                                <div class="d-flex justify-content-between mb-3 text-dark">
                                    <span class="fs-6">IGV (18%):</span>
                                    <span class="fw-semibold" id="tax">S/ 0.00</span>
                                </div>
                                <div class="section-divider"></div>
                                <div class="d-flex justify-content-between fw-bold fs-3">
                                    <span class="text-dark">TOTAL:</span>
                                    <span class="gradient-text-blue" id="total">S/ 0.00</span>
                                </div>
                            </div>

                            <div id="free-shipping-alert" class="alert alert-success mt-4 border-0 bg-success bg-opacity-20 text-dark" style="display: none;">
                                <i class="fas fa-truck me-2 text-success"></i>
                                <strong>¡ENVÍO GRATUITO INCLUIDO!</strong>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Columna derecha - Formulario -->
                <div class="col-xl-8 col-lg-7">
                    <div class="card card-premium glass-dark slide-in-right">
                        <div class="card-header text-center py-4 border-0" style="background: linear-gradient(135deg, #3b82f6, #1d4ed8)">
                            <h4 class="mb-0 fw-bold text-white">
                                <i class="fas fa-clipboard-list me-3"></i>
                                INFORMACIÓN DE ENTREGA Y PAGO
                            </h4>
                        </div>
                        <div class="card-body p-5">
                            <form id="checkout-form">
                                <!-- Información de contacto -->
                                <div class="mb-5">
                                    <div class="d-flex align-items-center mb-4">
                                        <div class="bg-primary bg-opacity-20 rounded-circle p-4 me-4">
                                            <i class="fas fa-user-tie fa-xl text-blue"></i>
                                        </div>
                                        <div>
                                            <h5 class="mb-2 fw-bold gradient-text-blue">INFORMACIÓN PERSONAL</h5>
                                            <small class="text-dark opacity-75">Datos para facturación y contacto</small>
                                        </div>
                                    </div>
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <label class="form-label fw-bold text-blue">NOMBRE(S) *</label>
                                            <input type="text" class="form-control form-control-lg input-premium" 
                                                   name="firstName" id="firstName" placeholder="Juan Carlos" required>
                                            <div class="error-text" id="firstName-error"></div>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label fw-bold text-blue">APELLIDO(S) *</label>
                                            <input type="text" class="form-control form-control-lg input-premium" 
                                                   name="lastName" id="lastName" placeholder="García López" required>
                                            <div class="error-text" id="lastName-error"></div>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label fw-bold text-blue">EMAIL *</label>
                                            <input type="email" class="form-control form-control-lg input-premium" 
                                                   name="email" id="email" placeholder="correo@ejemplo.com" required>
                                            <div class="error-text" id="email-error"></div>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label fw-bold text-blue">TELÉFONO (9 dígitos) *</label>
                                            <input type="tel" class="form-control form-control-lg input-premium" 
                                                   name="phone" id="phone" placeholder="999888777" maxlength="9" required>
                                            <div class="error-text" id="phone-error"></div>
                                        </div>
                                    </div>
                                </div>

                                <div class="section-divider"></div>

                                <!-- Dirección de entrega -->
                                <div class="mb-5">
                                    <div class="d-flex align-items-center mb-4">
                                        <div class="bg-success bg-opacity-20 rounded-circle p-4 me-4">
                                            <i class="fas fa-map-marked-alt fa-xl text-success"></i>
                                        </div>
                                        <div>
                                            <h5 class="mb-2 fw-bold gradient-text-blue">DIRECCIÓN DE ENTREGA</h5>
                                            <small class="text-dark opacity-75">Ubicación para la entrega de muebles</small>
                                        </div>
                                    </div>

                                    <!-- Toggle para modo de dirección -->
                                    <div class="address-mode-toggle d-flex mb-4">
                                        <button type="button" class="address-mode-btn active" id="manual-mode-btn">
                                            <i class="fas fa-edit me-2"></i>
                                            Escribir Dirección
                                        </button>
                                        <button type="button" class="address-mode-btn" id="map-mode-btn">
                                            <i class="fas fa-map-marker-alt me-2"></i>
                                            Buscar en Mapa
                                        </button>
                                    </div>

                                    <div class="row g-3">
                                        <div class="col-12">
                                            <label class="form-label fw-bold text-blue">DIRECCIÓN COMPLETA *</label>
                                            <div class="d-flex">
                                                <input type="text" class="form-control form-control-lg input-premium" 
                                                       name="address" id="address" placeholder="Av. Javier Prado Este 123, San Isidro" required>
                                                <button type="button" class="btn btn-premium ms-2" id="open-map-btn" title="Buscar en mapa">
                                                    <i class="fas fa-map-marker-alt"></i>
                                                </button>
                                            </div>
                                            <div class="error-text" id="address-error"></div>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label fw-bold text-blue">DEPARTAMENTO *</label>
                                            <select class="form-control form-control-lg input-premium" name="department" id="department" required>
                                                <option value="">Seleccionar</option>
                                                <option value="Lima">Lima</option>
                                                <option value="Arequipa">Arequipa</option>
                                                <option value="Trujillo">Trujillo</option>
                                                <option value="Chiclayo">Chiclayo</option>
                                                <option value="Piura">Piura</option>
                                                <option value="Cusco">Cusco</option>
                                                <option value="Huancayo">Huancayo</option>
                                                <option value="Tacna">Tacna</option>
                                            </select>
                                            <div class="error-text" id="department-error"></div>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label fw-bold text-blue">DISTRITO *</label>
                                            <input type="text" class="form-control form-control-lg input-premium" 
                                                   name="district" id="district" placeholder="San Isidro" required>
                                            <div class="error-text" id="district-error"></div>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label fw-bold text-blue">CÓDIGO POSTAL *</label>
                                            <input type="text" class="form-control form-control-lg input-premium" 
                                                   name="zipCode" id="zipCode" placeholder="15036" maxlength="5" required>
                                            <div class="error-text" id="zipCode-error"></div>
                                        </div>
                                    </div>
                                </div>

                                <div class="section-divider"></div>

                                <!-- Métodos de pago -->
                                <div class="mb-5">
                                    <div class="d-flex align-items-center mb-4">
                                        <div class="bg-info bg-opacity-20 rounded-circle p-4 me-4">
                                            <i class="fas fa-credit-card fa-xl text-info"></i>
                                        </div>
                                        <div>
                                            <h5 class="mb-2 fw-bold gradient-text-blue">MÉTODO DE PAGO</h5>
                                            <small class="text-dark opacity-75">Seleccione su opción preferida</small>
                                        </div>
                                    </div>

                                    <!-- Opciones de pago -->
                                    <div class="row g-3 mb-5">
                                        <div class="col-lg-3 col-md-6">
                                            <div class="payment-option active yape h-100" data-method="yape">
                                                <div class="card-body text-center p-4">
                                                    <i class="fas fa-mobile-alt fa-3x mb-3 d-block"></i>
                                                    <h6 class="fw-bold mb-2">YAPE</h6>
                                                    <small>QR Instantáneo</small>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-lg-3 col-md-6">
                                            <div class="payment-option h-100" data-method="plin">
                                                <div class="card-body text-center p-4">
                                                    <i class="fas fa-qrcode fa-3x mb-3 d-block"></i>
                                                    <h6 class="fw-bold mb-2">PLIN</h6>
                                                    <small>QR Disponible</small>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-lg-3 col-md-6">
                                            <div class="payment-option h-100" data-method="paypal">
                                                <div class="card-body text-center p-4">
                                                    <i class="fab fa-paypal fa-3x mb-3 d-block"></i>
                                                    <h6 class="fw-bold mb-2">PAYPAL</h6>
                                                    <small>Pago Express</small>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-lg-3 col-md-6">
                                            <div class="payment-option h-100" data-method="card">
                                                <div class="card-body text-center p-4">
                                                    <i class="fas fa-credit-card fa-3x mb-3 d-block"></i>
                                                    <h6 class="fw-bold mb-2">TARJETA</h6>
                                                    <small>Crédito/Débito</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Contenedor para formularios de pago -->
                                    <div id="payment-forms">
                                        <!-- Los formularios de pago se cargarán dinámicamente -->
                                    </div>
                                </div>

                                <!-- Botón de envío -->
                                <div class="text-center" id="submit-button-container">
                                    <button type="submit" class="btn btn-premium btn-lg px-5 py-4 fw-bold fs-5" id="submit-btn">
                                        <i class="fas fa-home me-3"></i>
                                        FINALIZAR COMPRA DE MUEBLES
                                    </button>
                                </div>
                            </form>

                            <!-- Estado del pago -->
                            <div id="payment-status" style="display: none;">
                                <!-- El estado se mostrará dinámicamente -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal de mapa -->
        <div id="map-modal" class="map-overlay" style="display: none;">
            <div class="map-panel">
                <div class="text-center mb-4">
                    <h4 class="fw-bold gradient-text-blue">
                        <i class="fas fa-map-marker-alt me-3"></i>
                        BUSCAR DIRECCIÓN EN MAPA INTERACTIVO
                    </h4>
                    <p class="text-dark">Busca tu ubicación o haz clic en el mapa para seleccionar</p>
                </div>

                <!-- Buscador -->
                <form id="map-search-form" class="mb-4">
                    <div class="d-flex">
                        <input type="text" class="form-control form-control-lg input-premium" 
                               id="map-search-input" placeholder="Buscar dirección, calle, avenida...">
                        <button type="submit" class="btn btn-premium ms-2" id="search-btn">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </form>

                <!-- Mapa interactivo -->
                <div id="map-container" style="height: 400px; border-radius: 15px; overflow: hidden; margin: 20px 0;">
                    <div class="text-center d-flex align-items-center justify-content-center h-100 map-container">
                        <div>
                            <i class="fas fa-map fa-3x text-blue mb-3"></i>
                            <p class="text-dark">Cargando mapa interactivo...</p>
                        </div>
                    </div>
                </div>

                <!-- Resultados de búsqueda -->
                <div id="search-results" style="display: none;">
                    <h6 class="fw-bold text-blue mb-3">RESULTADOS DE BÚSQUEDA:</h6>
                    <div id="results-list" style="max-height: 200px; overflow-y: auto;">
                        <!-- Los resultados se cargarán dinámicamente -->
                    </div>
                </div>

                <!-- Ubicación seleccionada -->
                <div id="selected-location" style="display: none;">
                    <h6 class="fw-bold text-blue mb-3">UBICACIÓN SELECCIONADA:</h6>
                    <div id="selected-location-info" class="location-result selected">
                        <!-- La información se cargará dinámicamente -->
                    </div>
                </div>

                <!-- Instrucciones -->
                <div class="alert alert-info border-0 bg-info bg-opacity-20 mb-4">
                    <i class="fas fa-info-circle me-2 text-info"></i>
                    <strong>Instrucciones:</strong>
                    <ul class="mb-0 mt-2 text-dark">
                        <li>Busca tu dirección en el campo de búsqueda</li>
                        <li>O haz clic directamente en el mapa para seleccionar una ubicación</li>
                        <li>Confirma la dirección seleccionada</li>
                    </ul>
                </div>

                <!-- Botones -->
                <div class="text-center">
                    <button class="btn btn-success-premium me-3 btn-lg" id="confirm-location-btn" disabled>
                        <i class="fas fa-check me-2"></i>
                        CONFIRMAR DIRECCIÓN
                    </button>
                    <button class="btn btn-secondary btn-lg" id="cancel-map-btn">
                        <i class="fas fa-times me-2"></i>
                        CANCELAR
                    </button>
                </div>
            </div>
        </div>

        <!-- Modal de boleta -->
        <div id="invoice-modal" class="invoice-overlay" style="display: none;">
            <div class="invoice-panel">
                <div class="text-center mb-5">
                    <h3 class="fw-bold gradient-text-blue">BOLETA DE VENTA MUEBLERÍA</h3>
                    <p class="text-blue fs-5" id="order-number">Orden: ARM-12345678</p>
                    <div class="section-divider"></div>
                </div>

                <div class="row mb-5">
                    <div class="col-6">
                        <h6 class="fw-bold text-blue">CLIENTE:</h6>
                        <div id="customer-info">
                            <!-- La información del cliente se cargará dinámicamente -->
                        </div>
                    </div>
                    <div class="col-6">
                        <h6 class="fw-bold text-blue">ENTREGA:</h6>
                        <div id="delivery-info">
                            <!-- La información de entrega se cargará dinámicamente -->
                        </div>
                    </div>
                </div>

                <div class="table-responsive mb-5">
                    <table class="table table-light">
                        <thead>
                            <tr class="border-blue">
                                <th class="text-blue">Mueble</th>
                                <th class="text-blue">Cant.</th>
                                <th class="text-blue">Precio</th>
                                <th class="text-blue">Total</th>
                            </tr>
                        </thead>
                        <tbody id="invoice-products">
                            <!-- Los productos se cargarán dinámicamente -->
                        </tbody>
                    </table>
                </div>

                <div class="border-top border-blue pt-4">
                    <div class="d-flex justify-content-between mb-2 text-dark">
                        <span>Subtotal:</span>
                        <span id="invoice-subtotal">S/ 0.00</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2 text-dark">
                        <span>Envío:</span>
                        <span id="invoice-shipping">S/ 0.00</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2 text-dark">
                        <span>IGV:</span>
                        <span id="invoice-tax">S/ 0.00</span>
                    </div>
                    <div class="section-divider"></div>
                    <div class="d-flex justify-content-between fw-bold fs-3">
                        <span class="text-dark">TOTAL:</span>
                        <span class="gradient-text-blue" id="invoice-total">S/ 0.00</span>
                    </div>
                </div>

                <div class="text-center mt-5">
                    <button class="btn btn-success-premium me-3 btn-lg" id="send-email-btn">
                        <i class="fas fa-envelope me-2"></i>
                        ENVIAR EMAIL
                    </button>
                    <button class="btn btn-danger-premium me-3 btn-lg" id="download-pdf-btn">
                        <i class="fas fa-download me-2"></i>
                        DESCARGAR PDF
                    </button>
                    <button class="btn btn-secondary btn-lg" id="close-invoice-btn">
                        CERRAR
                    </button>
                </div>
            </div>
        </div>

        <!-- PayPal Button Container -->
        <div id="paypal-button-container" style="display: none;"></div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- PayPal SDK -->
    <script src="https://www.paypal.com/sdk/js?client-id=sb&currency=USD&locale=es_PE&components=buttons"></script>
    
    <script>
        // Variables globales
        let currentPaymentMethod = 'yape';
        let mapInstance = null;
        let selectedMapLocation = null;
        let isProcessing = false;

        // Datos de productos (simulados)
        const products = [
            {
                id: '1',
                name: 'Sofá Moderno Premium',
                price: 2500.00,
                quantity: 1,
                image: '../../../public/imgMuebles/mueble1.jpg'
            },
            {
                id: '2',
                name: 'Mesa de Centro Elegante',
                price: 800.00,
                quantity: 1,
                image: '../../../public/imgMuebles/mueble9.jpg'
            },
            {
                id: '3',
                name: 'Lámpara de Pie Moderna',
                price: 450.00,
                quantity: 2,
                image: '../../../public/imgMuebles/mueble10.jpg'
            }
        ];

        // Inicialización cuando se carga la página
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            loadProducts();
            calculateTotals();
            setupEventListeners();
            showPaymentForm(currentPaymentMethod);
        }

        function loadProducts() {
            const productsList = document.getElementById('products-list');
            productsList.innerHTML = '';

            products.forEach((product, index) => {
                const productElement = document.createElement('div');
                productElement.className = 'product-item';
                productElement.style.animationDelay = `${index * 0.1}s`;
                
                productElement.innerHTML = `
                    <div class="d-flex align-items-center">
                        <img src="${product.image}" alt="${product.name}" 
                             class="rounded-3 me-3" style="width: 70px; height: 70px; object-fit: cover;">
                        <div class="flex-grow-1">
                            <h6 class="mb-2 fw-bold text-dark">${product.name}</h6>
                            <small class="text-blue">Cantidad: ${product.quantity}</small>
                            <div class="fw-bold text-primary-custom fs-5 mt-1">
                                S/ ${(product.price * product.quantity).toFixed(2)}
                            </div>
                        </div>
                    </div>
                `;
                
                productsList.appendChild(productElement);
            });
        }

        function calculateTotals() {
            const subtotal = products.reduce((sum, product) => sum + (product.price * product.quantity), 0);
            const shipping = subtotal > 1500 ? 0 : 50;
            const tax = subtotal * 0.18;
            const total = subtotal + shipping + tax;

            document.getElementById('subtotal').textContent = `S/ ${subtotal.toFixed(2)}`;
            document.getElementById('shipping').textContent = shipping === 0 ? 'GRATIS' : `S/ ${shipping.toFixed(2)}`;
            document.getElementById('tax').textContent = `S/ ${tax.toFixed(2)}`;
            document.getElementById('total').textContent = `S/ ${total.toFixed(2)}`;

            // Mostrar alerta de envío gratis
            const freeShippingAlert = document.getElementById('free-shipping-alert');
            if (shipping === 0) {
                freeShippingAlert.style.display = 'block';
            } else {
                freeShippingAlert.style.display = 'none';
            }

            return { subtotal, shipping, tax, total };
        }

        function setupEventListeners() {
            // Validación en tiempo real de campos
            const formFields = ['firstName', 'lastName', 'email', 'phone', 'address', 'department', 'district', 'zipCode'];
            formFields.forEach(fieldName => {
                const field = document.getElementById(fieldName);
                if (field) {
                    field.addEventListener('input', () => validateField(fieldName, field.value));
                    field.addEventListener('blur', () => validateField(fieldName, field.value));
                }
            });

            // Formateo especial para teléfono
            const phoneField = document.getElementById('phone');
            if (phoneField) {
                phoneField.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\D/g, '').slice(0, 9);
                    e.target.value = value;
                    validateField('phone', value);
                });
            }

            // Opciones de pago
            const paymentOptions = document.querySelectorAll('.payment-option');
            paymentOptions.forEach(option => {
                option.addEventListener('click', function() {
                    const method = this.getAttribute('data-method');
                    selectPaymentMethod(method);
                });
            });

            // Botones de modo de dirección
            document.getElementById('manual-mode-btn').addEventListener('click', () => setAddressMode('manual'));
            document.getElementById('map-mode-btn').addEventListener('click', () => setAddressMode('map'));
            document.getElementById('open-map-btn').addEventListener('click', () => openMapModal());

            // Formulario principal
            document.getElementById('checkout-form').addEventListener('submit', handleFormSubmit);

            // Modal de mapa
            document.getElementById('map-search-form').addEventListener('submit', handleMapSearch);
            document.getElementById('confirm-location-btn').addEventListener('click', confirmMapLocation);
            document.getElementById('cancel-map-btn').addEventListener('click', closeMapModal);

            // Modal de boleta
            document.getElementById('send-email-btn').addEventListener('click', sendInvoiceByEmail);
            document.getElementById('download-pdf-btn').addEventListener('click', downloadInvoicePDF);
            document.getElementById('close-invoice-btn').addEventListener('click', closeInvoiceModal);

            // Cerrar modales al hacer clic fuera
            document.getElementById('map-modal').addEventListener('click', function(e) {
                if (e.target === this) closeMapModal();
            });
            
            document.getElementById('invoice-modal').addEventListener('click', function(e) {
                if (e.target === this) closeInvoiceModal();
            });
        }

        // Validaciones
        function validateField(fieldName, value) {
            let error = '';
            
            switch (fieldName) {
                case 'firstName':
                case 'lastName':
                    if (!/^[a-zA-ZáéíóúÁÉÍÓÚñÑ\s]+$/.test(value)) {
                        error = 'Solo se permiten letras y espacios';
                    } else if (value.length < 2) {
                        error = 'Debe tener al menos 2 caracteres';
                    }
                    break;
                    
                case 'email':
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if (!emailRegex.test(value)) {
                        error = 'Ingrese un email válido con dominio';
                    }
                    break;
                    
                case 'phone':
                    const phoneRegex = /^[0-9]{9}$/;
                    if (!phoneRegex.test(value.replace(/\s/g, ''))) {
                        error = 'El teléfono debe tener exactamente 9 dígitos';
                    }
                    break;
                    
                case 'address':
                    if (value.length < 10) {
                        error = 'La dirección debe ser más específica';
                    }
                    break;
                    
                case 'zipCode':
                    if (!/^[0-9]{5}$/.test(value)) {
                        error = 'El código postal debe tener 5 dígitos';
                    }
                    break;
                    
                default:
                    if (value.trim().length === 0) {
                        error = 'Este campo es requerido';
                    }
            }
            
            const field = document.getElementById(fieldName);
            const errorElement = document.getElementById(`${fieldName}-error`);
            
            if (error) {
                field.classList.add('error');
                if (errorElement) errorElement.textContent = error;
            } else {
                field.classList.remove('error');
                if (errorElement) errorElement.textContent = '';
            }
            
            return error === '';
        }

        function validateAllFields() {
            const formData = getFormData();
            let isValid = true;
            
            Object.keys(formData).forEach(fieldName => {
                if (!validateField(fieldName, formData[fieldName])) {
                    isValid = false;
                }
            });
            
            return isValid;
        }

        function getFormData() {
            return {
                firstName: document.getElementById('firstName').value,
                lastName: document.getElementById('lastName').value,
                email: document.getElementById('email').value,
                phone: document.getElementById('phone').value,
                address: document.getElementById('address').value,
                department: document.getElementById('department').value,
                district: document.getElementById('district').value,
                zipCode: document.getElementById('zipCode').value
            };
        }

        // Métodos de pago
        function selectPaymentMethod(method) {
            currentPaymentMethod = method;
            
            // Actualizar UI de opciones de pago
            document.querySelectorAll('.payment-option').forEach(option => {
                option.classList.remove('active', 'yape', 'plin', 'paypal');
                if (option.getAttribute('data-method') === method) {
                    option.classList.add('active', method);
                }
            });
            
            showPaymentForm(method);
        }

        function showPaymentForm(method) {
            const paymentForms = document.getElementById('payment-forms');
            const submitContainer = document.getElementById('submit-button-container');
            
            let formHTML = '';
            
            switch (method) {
                case 'yape':
                    formHTML = `
                        <div class="glass-light rounded-4 p-5 fade-in-up">
                            <h5 class="fw-bold mb-4 text-center gradient-text-blue">
                                <i class="fas fa-mobile-alt me-3"></i>
                                PAGO CON YAPE - DIEGO
                            </h5>
                            <div class="row align-items-center">
                                <div class="col-md-6 text-center mb-4">
                                    <div class="qr-frame yape">
                                        <img src="https://hebbkx1anhila5yf.public.blob.vercel-storage.com/QRYAPE-ej7EWY1ldSICfKbGYJlfpulbN5Qmuu.png" alt="QR Code Yape" class="rounded">
                                    </div>
                                    <p class="mt-4 fw-bold text-purple fs-5">
                                        <i class="fas fa-user me-2"></i>
                                        DIEGO
                                    </p>
                                </div>
                                <div class="col-md-6">
                                    <div class="bg-light-premium p-4 rounded-4 border border-blue">
                                        <h6 class="fw-bold mb-4 text-blue">INSTRUCCIONES:</h6>
                                        <div class="mb-3 text-dark">
                                            <span class="badge bg-primary text-white me-3 fw-bold">1</span>
                                            Abre tu app <strong class="text-blue">YAPE</strong>
                                        </div>
                                        <div class="mb-3 text-dark">
                                            <span class="badge bg-primary text-white me-3 fw-bold">2</span>
                                            Escanea el código QR
                                        </div>
                                        <div class="mb-3 text-dark">
                                            <span class="badge bg-primary text-white me-3 fw-bold">3</span>
                                            Confirma el monto: <strong class="text-primary-custom">S/ ${calculateTotals().total.toFixed(2)}</strong>
                                        </div>
                                        <div class="text-dark">
                                            <span class="badge bg-primary text-white me-3 fw-bold">4</span>
                                            Completa el pago
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    submitContainer.style.display = 'block';
                    break;
                    
                case 'plin':
                    formHTML = `
                        <div class="glass-light rounded-4 p-5 fade-in-up">
                            <h5 class="fw-bold mb-4 text-center gradient-text-blue">
                                <i class="fas fa-qrcode me-3"></i>
                                PAGO CON PLIN - ERICK
                            </h5>
                            <div class="row align-items-center">
                                <div class="col-md-6 text-center mb-4">
                                    <div class="qr-frame plin">
                                        <img src="https://hebbkx1anhila5yf.public.blob.vercel-storage.com/QRPLIN.jpg-j56KIn3zXNEnwYVY9N8pYYcsgcHeUo.jpeg" alt="QR Code Plin" class="rounded">
                                    </div>
                                    <p class="mt-4 fw-bold text-primary fs-5">
                                        <i class="fas fa-user me-2"></i>
                                        ERICK
                                    </p>
                                </div>
                                <div class="col-md-6">
                                    <div class="bg-light-premium p-4 rounded-4 border border-blue">
                                        <h6 class="fw-bold mb-4 text-blue">INSTRUCCIONES:</h6>
                                        <div class="mb-3 text-dark">
                                            <span class="badge bg-primary text-white me-3 fw-bold">1</span>
                                            Abre tu app <strong class="text-blue">PLIN</strong>
                                        </div>
                                        <div class="mb-3 text-dark">
                                            <span class="badge bg-primary text-white me-3 fw-bold">2</span>
                                            Selecciona "Pagar con QR"
                                        </div>
                                        <div class="mb-3 text-dark">
                                            <span class="badge bg-primary text-white me-3 fw-bold">3</span>
                                            Escanea este código QR
                                        </div>
                                        <div class="mb-3 text-dark">
                                            <span class="badge bg-primary text-white me-3 fw-bold">4</span>
                                            Confirma el monto: <strong class="text-primary-custom">S/ ${calculateTotals().total.toFixed(2)}</strong>
                                        </div>
                                        <div class="text-dark">
                                            <span class="badge bg-primary text-white me-3 fw-bold">5</span>
                                            Completa el pago
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    submitContainer.style.display = 'block';
                    break;
                    
                case 'paypal':
                    formHTML = `
                        <div class="glass-light rounded-4 p-5 text-center fade-in-up">
                            <i class="fab fa-paypal fa-5x text-primary mb-4 floating-glow"></i>
                            <h5 class="fw-bold mb-4 gradient-text-blue">PAGO CON PAYPAL</h5>
                            <p class="mb-4 text-dark fs-5">Procesamiento seguro internacional</p>
                            <p class="mb-3 text-muted">Total: <strong>S/ ${calculateTotals().total.toFixed(2)} (≈ $${(calculateTotals().total / 3.8).toFixed(2)} USD)</strong></p>
                            <div id="paypal-button-container-form" style="max-width: 400px; margin: 0 auto;"></div>
                            <div class="alert alert-info border-0 bg-info bg-opacity-20 mt-3">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>PAYPAL SANDBOX:</strong> Modo de prueba para desarrollo
                            </div>
                        </div>
                    `;
                    submitContainer.style.display = 'none';
                    
                    // Inicializar PayPal después de que se renderice el HTML
                    setTimeout(() => {
                        initializePayPal();
                    }, 200);
                    break;
                    
                case 'card':
                    formHTML = `
                        <div class="glass-light rounded-4 p-5 fade-in-up">
                            <h5 class="fw-bold mb-4 gradient-text-blue">
                                <i class="fas fa-credit-card me-3"></i>
                                INFORMACIÓN DE TARJETA
                            </h5>
                            <div class="row g-3">
                                <div class="col-12">
                                    <label class="form-label fw-bold text-blue">NÚMERO DE TARJETA</label>
                                    <input type="text" class="form-control form-control-lg input-premium" 
                                           id="cardNumber" placeholder="1234 5678 9012 3456" maxlength="19">
                                </div>
                                <div class="col-md-8">
                                    <label class="form-label fw-bold text-blue">NOMBRE DEL TITULAR</label>
                                    <input type="text" class="form-control form-control-lg input-premium" 
                                           id="cardName" placeholder="Como aparece en la tarjeta">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label fw-bold text-blue">MM/AA</label>
                                    <input type="text" class="form-control form-control-lg input-premium" 
                                           id="expiryDate" placeholder="12/25" maxlength="5">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label fw-bold text-blue">CVV</label>
                                    <input type="text" class="form-control form-control-lg input-premium" 
                                           id="cvv" placeholder="123" maxlength="4">
                                </div>
                            </div>
                        </div>
                    `;
                    submitContainer.style.display = 'block';
                    break;
            }
            
            paymentForms.innerHTML = formHTML;
            
            // Configurar formateo de tarjeta si es necesario
            if (method === 'card') {
                const cardNumberField = document.getElementById('cardNumber');
                if (cardNumberField) {
                    cardNumberField.addEventListener('input', formatCardNumber);
                }
            }
        }

        function initializePayPal() {
            const container = document.getElementById('paypal-button-container-form');
            if (!container) {
                console.error('Contenedor de PayPal no encontrado');
                return;
            }

            // Limpiar contenedor anterior
            container.innerHTML = '';

            const totals = calculateTotals();
            const totalUSD = (totals.total / 3.8).toFixed(2); // Conversión aproximada PEN a USD

            // Verificar si PayPal está disponible
            if (typeof paypal === 'undefined') {
                container.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Error cargando PayPal. <button class="btn btn-sm btn-primary ms-2" onclick="location.reload()">Recargar página</button>
                    </div>
                `;
                return;
            }

            try {
                paypal.Buttons({
                    createOrder: function(data, actions) {
                        return actions.order.create({
                            purchase_units: [{
                                amount: {
                                    value: totalUSD,
                                    currency_code: 'USD'
                                },
                                description: 'Compra de muebles - Armadirique'
                            }]
                        });
                    },
                    onApprove: function(data, actions) {
                        return actions.order.capture().then(function(details) {
                            console.log('Pago exitoso:', details);
                            showPaymentStatus('success', `¡Pago PayPal exitoso! Transacción ID: ${details.id}`);
                            showInvoiceModal();
                        });
                    },
                    onError: function(err) {
                        console.error('Error en PayPal:', err);
                        showPaymentStatus('error', 'Error en el procesamiento de PayPal. Intente nuevamente.');
                    },
                    onCancel: function(data) {
                        console.log('Pago cancelado:', data);
                        showPaymentStatus('error', 'Pago cancelado por el usuario.');
                    },
                    style: {
                        layout: 'vertical',
                        color: 'blue',
                        shape: 'rect',
                        label: 'paypal',
                        height: 40
                    }
                }).render('#paypal-button-container-form').catch(function(err) {
                    console.error('Error renderizando PayPal:', err);
                    container.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-circle me-2"></i>
                            Error inicializando PayPal. 
                            <button class="btn btn-sm btn-primary ms-2" onclick="initializePayPal()">Reintentar</button>
                        </div>
                    `;
                });
            } catch (error) {
                console.error('Error en inicialización de PayPal:', error);
                container.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        Error de configuración de PayPal.
                        <button class="btn btn-sm btn-primary ms-2" onclick="initializePayPal()">Reintentar</button>
                    </div>
                `;
            }
        }

        function formatCardNumber(e) {
            let value = e.target.value.replace(/\s+/g, '').replace(/[^0-9]/gi, '');
            let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
            e.target.value = formattedValue;
        }

        // Manejo de direcciones y mapa
        function setAddressMode(mode) {
            const manualBtn = document.getElementById('manual-mode-btn');
            const mapBtn = document.getElementById('map-mode-btn');
            const addressField = document.getElementById('address');
            
            if (mode === 'manual') {
                manualBtn.classList.add('active');
                mapBtn.classList.remove('active');
                addressField.readOnly = false;
            } else {
                manualBtn.classList.remove('active');
                mapBtn.classList.add('active');
                openMapModal();
            }
        }

        function openMapModal() {
            document.getElementById('map-modal').style.display = 'flex';
            setTimeout(initializeMap, 100);
        }

        function closeMapModal() {
            document.getElementById('map-modal').style.display = 'none';
            if (mapInstance) {
                mapInstance.remove();
                mapInstance = null;
            }
            selectedMapLocation = null;
            document.getElementById('search-results').style.display = 'none';
            document.getElementById('selected-location').style.display = 'none';
            document.getElementById('map-search-input').value = '';
        }

        function initializeMap() {
            if (mapInstance) return;
            
            const mapContainer = document.getElementById('map-container');
            mapContainer.innerHTML = '';
            
            // Coordenadas de Lima, Perú como centro inicial
            mapInstance = L.map('map-container').setView([-12.0464, -77.0428], 13);
            
            // Añadir capa de mapa
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(mapInstance);
            
            let marker = null;
            
            // Evento de click en el mapa
            mapInstance.on('click', function(e) {
                const { lat, lng } = e.latlng;
                
                // Remover marcador anterior si existe
                if (marker) {
                    mapInstance.removeLayer(marker);
                }
                
                // Añadir nuevo marcador
                marker = L.marker([lat, lng]).addTo(mapInstance);
                
                // Geocodificación inversa para obtener la dirección
                reverseGeocode(lat, lng);
            });
        }

        async function handleMapSearch(e) {
            e.preventDefault();
            const query = document.getElementById('map-search-input').value.trim();
            if (!query) return;
            
            const searchBtn = document.getElementById('search-btn');
            searchBtn.innerHTML = '<div class="loading-premium" style="width: 20px; height: 20px;"></div>';
            
            try {
                const results = await searchLocation(query);
                displaySearchResults(results);
            } catch (error) {
                console.error('Error en búsqueda:', error);
            } finally {
                searchBtn.innerHTML = '<i class="fas fa-search"></i>';
            }
        }

        async function searchLocation(query) {
            const response = await fetch(
                `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}, Peru&limit=5&addressdetails=1`
            );
            
            if (!response.ok) throw new Error('Error en la búsqueda');
            
            const data = await response.json();
            
            return data.map(item => ({
                lat: parseFloat(item.lat),
                lng: parseFloat(item.lon),
                address: item.display_name.split(',').slice(0, 3).join(','),
                district: item.address?.suburb || item.address?.city_district || item.address?.neighbourhood || 'Lima',
                department: item.address?.state || 'Lima',
                zipCode: item.address?.postcode || '15001'
            }));
        }

        function displaySearchResults(results) {
            const searchResults = document.getElementById('search-results');
            const resultsList = document.getElementById('results-list');
            
            if (results.length === 0) {
                searchResults.style.display = 'none';
                return;
            }
            
            resultsList.innerHTML = '';
            
            results.forEach((result, index) => {
                const resultElement = document.createElement('div');
                resultElement.className = 'location-result';
                resultElement.innerHTML = `
                    <div class="d-flex align-items-center">
                        <i class="fas fa-map-pin me-3 text-blue"></i>
                        <div>
                            <h6 class="mb-1 text-dark">${result.address}</h6>
                            <small class="text-blue">${result.district}, ${result.department} - ${result.zipCode}</small>
                        </div>
                    </div>
                `;
                
                resultElement.addEventListener('click', () => selectLocationFromSearch(result));
                resultsList.appendChild(resultElement);
            });
            
            searchResults.style.display = 'block';
        }

        function selectLocationFromSearch(location) {
            selectedMapLocation = location;
            
            // Actualizar UI
            document.querySelectorAll('.location-result').forEach(el => el.classList.remove('selected'));
            event.currentTarget.classList.add('selected');
            
            // Centrar el mapa en la ubicación seleccionada
            if (mapInstance) {
                mapInstance.setView([location.lat, location.lng], 16);
                L.marker([location.lat, location.lng]).addTo(mapInstance);
            }
            
            displaySelectedLocation(location);
        }

        async function reverseGeocode(lat, lng) {
            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&addressdetails=1`
                );
                
                if (!response.ok) throw new Error('Error en geocodificación inversa');
                
                const data = await response.json();
                
                const location = {
                    lat,
                    lng,
                    address: data.display_name.split(',').slice(0, 3).join(','),
                    district: data.address?.suburb || data.address?.city_district || data.address?.neighbourhood || 'Lima',
                    department: data.address?.state || 'Lima',
                    zipCode: data.address?.postcode || '15001'
                };
                
                selectedMapLocation = location;
                displaySelectedLocation(location);
            } catch (error) {
                console.error('Error en geocodificación inversa:', error);
            }
        }

        function displaySelectedLocation(location) {
            const selectedLocationDiv = document.getElementById('selected-location');
            const selectedLocationInfo = document.getElementById('selected-location-info');
            
            selectedLocationInfo.innerHTML = `
                <div class="d-flex align-items-center">
                    <i class="fas fa-check-circle me-3 text-success"></i>
                    <div>
                        <h6 class="mb-1 text-dark">${location.address}</h6>
                        <small class="text-blue">${location.district}, ${location.department} - ${location.zipCode}</small>
                    </div>
                </div>
            `;
            
            selectedLocationDiv.style.display = 'block';
            document.getElementById('confirm-location-btn').disabled = false;
        }

        function confirmMapLocation() {
            if (!selectedMapLocation) return;
            
            // Actualizar campos del formulario
            document.getElementById('address').value = selectedMapLocation.address;
            document.getElementById('district').value = selectedMapLocation.district;
            document.getElementById('department').value = selectedMapLocation.department;
            document.getElementById('zipCode').value = selectedMapLocation.zipCode;
            
            closeMapModal();
            setAddressMode('manual');
        }

        // Manejo del formulario - MODIFICADO PARA ENVIAR A PYTHON
        function handleFormSubmit(e) {
            e.preventDefault();
            
            if (isProcessing) return;
            
            if (!validateAllFields()) {
                showPaymentStatus('error', 'Por favor corrige los errores en el formulario');
                return;
            }
            
            isProcessing = true;
            updateSubmitButton(true);
            
            // Enviar datos al servidor Python
            sendDataToPython();
        }

        async function sendDataToPython() {
            const formData = getFormData();
            const totals = calculateTotals();
            const orderNumber = `ARM-${Date.now().toString().slice(-8)}`;
            
            const dataToSend = {
                orderNumber: orderNumber,
                customer: formData,
                products: products,
                totals: totals,
                paymentMethod: currentPaymentMethod,
                timestamp: new Date().toISOString()
            };

            try {
                const response = await fetch('http://localhost:8000/process-payment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(dataToSend)
                });

                const result = await response.json();

                if (result.success) {
                    showPaymentStatus('success', '¡Pago procesado exitosamente! Se ha enviado la boleta por email.');
                    showInvoiceModal();
                } else {
                    showPaymentStatus('error', result.message || 'Error al procesar el pago');
                }
            } catch (error) {
                console.error('Error:', error);
                showPaymentStatus('error', 'Error de conexión. Asegúrate de que el servidor Python esté ejecutándose.');
            } finally {
                isProcessing = false;
                updateSubmitButton(false);
            }
        }

        function updateSubmitButton(processing) {
            const submitBtn = document.getElementById('submit-btn');
            
            if (processing) {
                submitBtn.innerHTML = `
                    <div class="loading-premium me-3" style="width: 25px; height: 25px;"></div>
                    PROCESANDO...
                `;
                submitBtn.disabled = true;
            } else {
                submitBtn.innerHTML = `
                    <i class="fas fa-home me-3"></i>
                    FINALIZAR COMPRA DE MUEBLES
                `;
                submitBtn.disabled = false;
            }
        }

        function showPaymentStatus(type, message) {
            const statusDiv = document.getElementById('payment-status');
            
            const statusClass = type === 'success' ? 'success-notification' : 'error-notification';
            const icon = type === 'success' ? 'fas fa-check-circle' : 'fas fa-exclamation-triangle';
            const title = type === 'success' ? '¡COMPRA EXITOSA!' : 'ERROR EN EL PROCESO';
            
            statusDiv.innerHTML = `
                <div class="${statusClass}">
                    <i class="${icon} fa-4x mb-4"></i>
                    <h4 class="fw-bold mb-3">${title}</h4>
                    <p class="mb-0 fs-5">${message}</p>
                    ${type === 'success' ? `
                        <div class="mt-5">
                            <button class="btn btn-success-premium me-3 btn-lg" onclick="sendInvoiceByEmail()">
                                <i class="fas fa-envelope me-2"></i>
                                REENVIAR EMAIL
                            </button>
                            <button class="btn btn-danger-premium btn-lg" onclick="downloadInvoicePDF()">
                                <i class="fas fa-download me-2"></i>
                                DESCARGAR PDF
                            </button>
                        </div>
                    ` : ''}
                </div>
            `;
            
            statusDiv.style.display = 'block';
        }

        // Manejo de boleta/factura
        function showInvoiceModal() {
            const formData = getFormData();
            const totals = calculateTotals();
            
            // Actualizar información del cliente
            document.getElementById('customer-info').innerHTML = `
                <p class="mb-2 text-dark fs-6">${formData.firstName} ${formData.lastName}</p>
                <p class="mb-2 text-dark">${formData.email}</p>
                <p class="mb-0 text-dark">${formData.phone}</p>
            `;
            
            // Actualizar información de entrega
            document.getElementById('delivery-info').innerHTML = `
                <p class="mb-2 text-dark fs-6">${formData.address}</p>
                <p class="mb-0 text-dark">${formData.district}, ${formData.department}</p>
            `;
            
            // Actualizar productos en la boleta
            const invoiceProducts = document.getElementById('invoice-products');
            invoiceProducts.innerHTML = '';
            
            products.forEach(product => {
                const row = document.createElement('tr');
                row.className = 'text-dark';
                row.innerHTML = `
                    <td>${product.name}</td>
                    <td>${product.quantity}</td>
                    <td>S/ ${product.price.toFixed(2)}</td>
                    <td>S/ ${(product.price * product.quantity).toFixed(2)}</td>
                `;
                invoiceProducts.appendChild(row);
            });
            
            // Actualizar totales en la boleta
            document.getElementById('invoice-subtotal').textContent = `S/ ${totals.subtotal.toFixed(2)}`;
            document.getElementById('invoice-shipping').textContent = `S/ ${totals.shipping.toFixed(2)}`;
            document.getElementById('invoice-tax').textContent = `S/ ${totals.tax.toFixed(2)}`;
            document.getElementById('invoice-total').textContent = `S/ ${totals.total.toFixed(2)}`;
            
            // Generar número de orden
            const orderNumber = `ARM-${Date.now().toString().slice(-8)}`;
            document.getElementById('order-number').textContent = `Orden: ${orderNumber}`;
            
            document.getElementById('invoice-modal').style.display = 'flex';
        }

        function closeInvoiceModal() {
            document.getElementById('invoice-modal').style.display = 'none';
        }

        function sendInvoiceByEmail() {
            if (isProcessing) return;
            
            isProcessing = true;
            const btn = document.getElementById('send-email-btn');
            const originalText = btn.innerHTML;
            
            btn.innerHTML = `
                <div class="loading-premium me-2" style="width: 20px; height: 20px;"></div>
                ENVIANDO...
            `;
            btn.disabled = true;
            
            setTimeout(() => {
                alert('¡Boleta reenviada exitosamente a su correo electrónico!');
                btn.innerHTML = originalText;
                btn.disabled = false;
                isProcessing = false;
            }, 2000);
        }

        async function downloadInvoicePDF() {
            const formData = getFormData();
            const totals = calculateTotals();
            const orderNumber = document.getElementById('order-number').textContent;
            
            const dataToSend = {
                orderNumber: orderNumber,
                customer: formData,
                products: products,
                totals: totals,
                paymentMethod: currentPaymentMethod
            };

            try {
                const response = await fetch('http://localhost:8000/generate-pdf', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(dataToSend)
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `Boleta_Armadirique_${Date.now()}.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                } else {
                    alert('Error al generar el PDF');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error de conexión al generar PDF');
            }
        }
    </script>
</body>
</html>